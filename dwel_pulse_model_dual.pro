pro DWEL_pulse_model_dual, wavelength, i_val, t_val, r_val, p_range, p_time, pulse
  compile_opt idl2
  
  ;THis routine sets up the model for the pulse.
  ;Many pulses has been set as an empirical model of an array at the step corresponding to 0.5 nsec sampling.
  ;This model may be interpolated to fit any other step size and is controlled by the position and magnitude
  ;of the peak of the pulse - the T_zero point
  ;
  ;Some information:
  ;
  ; Peak occurs at zero range or time with a value of 1.0
  ; FWHM is unknown right now
  ;
  ;INPUTS:
  ;
  ;     wavelength  wavelength of the laser of which the pulse model is needed
  ;     i_val     positions of first,Left 0.0001,peak,trough,secondary peak,Right 0.0001, last points
  ;     t_val     time vale of first,Left 0.0001,peak,trough,secondary peak,Right 0.0001, last points
  ;     r_val     range vale of first,Left 0.0001,peak,trough,secondary peak,Right 0.0001, last points
  ;     p_range   the range ordinates of the model
  ;     p_time    the time ordinates of the model
  ;     pulse     values of the normalised pulse (peak value = 1.0)
  ;
  
  c=0.299792458
  c2=c/2.0
  
  ;; NSF DWEL, CA Campaign 2013
  if (wavelength eq 1064) then begin
    ; Mean pulse model
    p_time=[ $
      -39.500000,-39.000000,-38.500000,-38.000000,-37.500000,-37.000000,-36.500000,-36.000000,-35.500000,-35.000000, $
      -34.500000,-34.000000,-33.500000,-33.000000,-32.500000,-32.000000,-31.500000,-31.000000,-30.500000,-30.000000, $
      -29.500000,-29.000000,-28.500000,-28.000000,-27.500000,-27.000000,-26.500000,-26.000000,-25.500000,-25.000000, $
      -24.500000,-24.000000,-23.500000,-23.000000,-22.500000,-22.000000,-21.500000,-21.000000,-20.500000,-20.000000, $
      -19.500000,-19.000000,-18.500000,-18.000000,-17.500000,-17.000000,-16.500000,-16.000000,-15.500000,-15.000000, $
      -14.500000,-14.000000,-13.500000,-13.000000,-12.500000,-12.000000,-11.500000,-11.000000,-10.500000,-10.000000, $
      -9.500000,-9.000000,-8.500000,-8.000000,-7.500000,-7.000000,-6.500000,-6.000000,-5.500000,-5.000000, $
      -4.500000,-4.000000,-3.500000,-3.000000,-2.500000,-2.000000,-1.500000,-1.000000,-0.500000,0.000000, $
      0.500000,1.000000,1.500000,2.000000,2.500000,3.000000,3.500000,4.000000,4.500000,5.000000, $
      5.500000,6.000000,6.500000,7.000000,7.500000,8.000000,8.500000,9.000000,9.500000,10.000000, $
      10.500000,11.000000,11.500000,12.000000,12.500000,13.000000,13.500000,14.000000,14.500000,15.000000, $
      15.500000,16.000000,16.500000,17.000000,17.500000,18.000000,18.500000,19.000000,19.500000,20.000000, $
      20.500000,21.000000,21.500000,22.000000,22.500000,23.000000,23.500000,24.000000,24.500000,25.000000, $
      25.500000,26.000000,26.500000,27.000000,27.500000,28.000000,28.500000,29.000000,29.500000,30.000000, $
      30.500000,31.000000,31.500000,32.000000,32.500000,33.000000,33.500000,34.000000,34.500000,35.000000, $
      35.500000,36.000000,36.500000,37.000000,37.500000,38.000000,38.500000,39.000000,39.500000]
      
    pulse = [ $
      -0.002732,-0.005479,0.001389,-0.004083,-0.002710,0.004155,0.001400,0.012378,0.004147,0.000023, $
      0.004140,-0.005457,0.001381,-0.013695,-0.009589,-0.008215,-0.006846,0.012359,0.001404,0.016472, $
      0.012366,0.015102,0.016476,0.000026,0.006868,-0.012310,-0.001347,-0.005453,-0.012302,0.000030, $
      -0.009555,0.008261,0.005532,0.008246,0.015099,0.005498,0.017820,0.008242,0.008230,0.001392, $
      0.006887,0.008246,0.002777,0.006864,0.008242,0.009600,0.013714,0.008238,0.009608,0.009619, $
      0.004136,0.006891,0.004151,0.005506,-0.004098,0.001381,0.015106,0.008249,0.015102,0.012374, $
      0.015117,0.015121,0.000038,0.005510,-0.005461,-0.001362,0.000004,-0.002740,0.012344,0.001396, $
      0.023337,0.038446,0.100184,0.211309,0.355359,0.547392,0.707892,0.868358,0.971210,1.000000, $
      0.945089,0.791457,0.604862,0.357963,0.124774,-0.067259,-0.238699,-0.340212,-0.393666,-0.388179, $
      -0.331925,-0.246861,-0.127544,-0.028763,0.065859,0.126216,0.165983,0.183814,0.174213,0.149515, $
      0.115234,0.074070,0.041152,0.000011,-0.020574,-0.035654,-0.052115,-0.042503,-0.042503,-0.026042, $
      -0.020548,-0.009582,0.010981,0.008242,0.030171,0.024691,0.038398,0.037028,0.030178,0.039771, $
      0.021955,0.026061,0.006864,0.008230,0.008230,-0.005472,0.009593,-0.004102,0.004113,0.008238, $
      0.010985,0.026061,0.012370,0.021955,0.017853,0.013729,0.016457,0.009608,0.013699,0.006857, $
      0.009589,0.013717,0.009600,0.010970,0.008234,0.010978,0.010985,0.005502,0.010981,0.009612, $
      0.016468,0.017838,0.017838,0.028816,0.023325,0.024688,0.024684,0.016450,0.019189]
  endif
  if (wavelength eq 1548) then begin
    ; Mean pulse model
    p_time=[ $
      -39.500000,-39.000000,-38.500000,-38.000000,-37.500000,-37.000000,-36.500000,-36.000000,-35.500000,-35.000000, $
      -34.500000,-34.000000,-33.500000,-33.000000,-32.500000,-32.000000,-31.500000,-31.000000,-30.500000,-30.000000, $
      -29.500000,-29.000000,-28.500000,-28.000000,-27.500000,-27.000000,-26.500000,-26.000000,-25.500000,-25.000000, $
      -24.500000,-24.000000,-23.500000,-23.000000,-22.500000,-22.000000,-21.500000,-21.000000,-20.500000,-20.000000, $
      -19.500000,-19.000000,-18.500000,-18.000000,-17.500000,-17.000000,-16.500000,-16.000000,-15.500000,-15.000000, $
      -14.500000,-14.000000,-13.500000,-13.000000,-12.500000,-12.000000,-11.500000,-11.000000,-10.500000,-10.000000, $
      -9.500000,-9.000000,-8.500000,-8.000000,-7.500000,-7.000000,-6.500000,-6.000000,-5.500000,-5.000000, $
      -4.500000,-4.000000,-3.500000,-3.000000,-2.500000,-2.000000,-1.500000,-1.000000,-0.500000,0.000000, $
      0.500000,1.000000,1.500000,2.000000,2.500000,3.000000,3.500000,4.000000,4.500000,5.000000, $
      5.500000,6.000000,6.500000,7.000000,7.500000,8.000000,8.500000,9.000000,9.500000,10.000000, $
      10.500000,11.000000,11.500000,12.000000,12.500000,13.000000,13.500000,14.000000,14.500000,15.000000, $
      15.500000,16.000000,16.500000,17.000000,17.500000,18.000000,18.500000,19.000000,19.500000,20.000000, $
      20.500000,21.000000,21.500000,22.000000,22.500000,23.000000,23.500000,24.000000,24.500000,25.000000, $
      25.500000,26.000000,26.500000,27.000000,27.500000,28.000000,28.500000,29.000000,29.500000,30.000000, $
      30.500000,31.000000,31.500000,32.000000,32.500000,33.000000,33.500000,34.000000,34.500000,35.000000, $
      35.500000,36.000000,36.500000,37.000000,37.500000,38.000000,38.500000,39.000000,39.500000]
      
    pulse = [ $
      -0.000661,0.001062,0.002924,-0.002123,-0.003585,-0.009433,-0.007571,-0.002524,-0.000661,0.000801, $
      0.003585,0.009694,0.005308,0.004907,0.004507,0.002384,0.000661,-0.003986,-0.002524,0.003324, $
      0.005448,0.001862,-0.001062,-0.007571,-0.008632,-0.010895,-0.011556,-0.007971,-0.004786,-0.002924, $
      0.003185,0.010755,0.016203,0.013419,0.012357,0.005848,0.001062,0.003185,0.001723,-0.001602, $
      -0.000801,-0.008632,-0.004907,-0.005168,-0.006630,-0.004107,-0.003445,-0.000261,0.006509,0.010094, $
      0.007170,-0.001201,0.000661,-0.003725,-0.004786,-0.003986,-0.002784,-0.001723,0.002002,-0.001183, $
      0.002263,0.008372,0.011417,0.014061,0.014462,0.011938,0.000521,-0.011556,-0.018326,-0.003185, $
      0.011295,0.050350,0.130443,0.246387,0.405474,0.585270,0.758958,0.895612,0.973964,1.000000, $
      0.969196,0.880489,0.750084,0.579841,0.394457,0.206410,0.043198,-0.091332,-0.196521,-0.248594, $
      -0.250074,-0.223256,-0.184080,-0.129763,-0.066674,-0.007310,0.039036,0.080735,0.105710,0.111558, $
      0.098680,0.079292,0.059504,0.035730,0.018065,-0.003986,-0.015141,-0.028821,-0.033467,-0.040638, $
      -0.037714,-0.027759,-0.016203,-0.004386,0.003324,0.002663,0.010634,0.006248,0.012618,0.014341, $
      0.020710,0.023634,0.021772,0.013940,0.005448,-0.006369,-0.008493,-0.010215,-0.008493,-0.008893, $
      -0.006770,-0.003324,0.007831,0.013540,0.017386,0.019108,0.019909,0.014601,0.010094,0.008111, $
      -0.005028,-0.001844,-0.007291,-0.007031,-0.006509,-0.011295,-0.009573,0.001844,0.011538,0.014462, $
      0.015002,0.003585,-0.002384,-0.005168,-0.005829,-0.005168,-0.010215,-0.010355,-0.006109]
  endif
  
  p_range = p_time*c2
  
  ;find where the left and right 0.0001*peak is
  tmp_I = where(pulse ge 0.0001)
  tmp = max(pulse, max_I)
  
  ;=====================================
  ; find the trough and secondary peak
  ; maximum peak location
  tmp = max(pulse, maxpeakloc)
  maxpeakloc = maxpeakloc[0]
  ; find the three zero-cross points after the maximum peak
  wflen = size(pulse, /n_elements)
  zero_xloc = where(pulse[maxpeakloc:wflen-2]*pulse[maxpeakloc+1:wflen-1] le 0, tmpcount) + maxpeakloc
  ; find the minimum and maximum between the first zero-cross point and the third zero-cross point
  tmp = min(pulse[zero_xloc[0]:zero_xloc[2]], tmploc)
  troughloc = fix(mean(tmploc)) + zero_xloc[0]
  tmp = max(pulse[zero_xloc[0]:zero_xloc[2]], tmploc)
  scdpeakloc = fix(mean(tmploc)) + zero_xloc[0]
  ;=====================================
  
  i_val=[0, tmp_I[0],  max_I, troughloc, scdpeakloc, tmp_I[n_elements(tmp_I)-1], n_elements(pulse)-1]
  
  r_val=[p_range[i_val[0]],p_range[i_val[1]],p_range[i_val[2]], p_range[i_val[3]], p_range[i_val[4]], p_range[i_val[5]],p_range[i_val[6]]]
  t_val=r_val/c2
  
  ;print,'p_val check=',[pulse[i_val[0]],pulse[i_val[1]],pulse[i_val[2]],pulse[i_val[3]],pulse[i_val[4]]]
  ;print,'expected number=',i_val[4]+1,' actual number=',n_elements(pulse)
  
  return
end

